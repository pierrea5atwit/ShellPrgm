name: C/C++ CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  # Linux/Unix testing
  test-unix:
    name: Test on ${{ matrix.os }} with ${{ matrix.compiler }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, ubuntu-20.04, macos-latest]
        compiler: [gcc, clang]
        exclude:
          # Skip clang on macOS as it's the default
          - os: macos-latest
            compiler: gcc
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Install dependencies (Ubuntu)
      if: startsWith(matrix.os, 'ubuntu')
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
    
    - name: Set compiler
      run: |
        if [ "${{ matrix.compiler }}" = "gcc" ]; then
          echo "CC=gcc" >> $GITHUB_ENV
        else
          echo "CC=clang" >> $GITHUB_ENV
        fi
    
    - name: Show build configuration
      run: |
        echo "OS: $(uname -s)"
        echo "Compiler: $CC"
        $CC --version
    
    - name: Build shell program
      run: make all
    
    - name: Build tests
      run: make test
    
    - name: Run test suite
      run: |
        chmod +x tests/run_tests.sh
        ./tests/run_tests.sh
    
    - name: Check for memory leaks (GCC on Ubuntu only)
      if: matrix.compiler == 'gcc' && startsWith(matrix.os, 'ubuntu')
      run: |
        sudo apt-get install -y valgrind
        echo "Running Valgrind memory leak checks..."
        for test in build/test_*; do
          if [ -f "$test" ]; then
            echo "Checking $test for memory leaks..."
            valgrind --leak-check=full --error-exitcode=1 --show-leak-kinds=all $test
          fi
        done
    
    - name: Upload test artifacts
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results-${{ matrix.os }}-${{ matrix.compiler }}
        path: |
          build/
          *.log
        retention-days: 7

  # Windows testing (build only, no POSIX tests)
  test-windows:
    name: Build on Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-gcc
          make
    
    - name: Build Windows shell
      shell: msys2 {0}
      run: |
        make all
        ls -la build/
    
    - name: Verify executable
      shell: msys2 {0}
      run: |
        if [ -f "build/shell.exe" ]; then
          echo "✓ Windows shell executable built successfully"
          file build/shell.exe
        else
          echo "✗ Build failed - executable not found"
          exit 1
        fi
    
    - name: Upload Windows build
      uses: actions/upload-artifact@v3
      with:
        name: windows-build
        path: build/shell.exe
        retention-days: 7

  # Code quality checks
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Install analysis tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck clang-format
    
    - name: Run static analysis
      run: |
        echo "Running cppcheck..."
        cppcheck --enable=all --suppress=missingIncludeSystem \
          --error-exitcode=1 --std=c11 \
          --inline-suppr \
          main.c unix_shell.c windows_shell.c tests/*.c
    
    - name: Check code formatting
      run: |
        echo "Checking code formatting..."
        # Check if code follows formatting style (warning only)
        clang-format --dry-run --Werror \
          main.c unix_shell.c windows_shell.c \
          unix_shell.h windows_shell.h \
          tests/*.c || echo "⚠ Code formatting issues found (non-blocking)"
    
    - name: Check for common issues
      run: |
        echo "Checking for common issues..."
        # Check for TODO/FIXME comments
        grep -rn "TODO\|FIXME" *.c *.h tests/*.c || echo "✓ No TODO/FIXME found"
        
        # Check for trailing whitespace
        if grep -rn "[[:blank:]]$" *.c *.h tests/*.c; then
          echo "⚠ Trailing whitespace found"
        else
          echo "✓ No trailing whitespace"
        fi
